# Configurazione Apache per Planora
# Questo file va aggiunto al VirtualHost di Apache (httpd.conf o sites-available/)

# NOTA: Prima di usare questa configurazione, abilita i moduli necessari:
# sudo a2enmod rewrite
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod headers
# sudo a2enmod ssl
# sudo service apache2 restart

<VirtualHost *:80>
    ServerName www.licenzeoriginali.com
    ServerAlias licenzeoriginali.com

    # Redirect HTTP to HTTPS (consigliato per produzione)
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

    DocumentRoot /var/www/html
    # oppure su XAMPP Windows: C:/xampp/htdocs
    # oppure su XAMPP Linux: /opt/lampp/htdocs

    # Frontend React - /planora
    <Directory /var/www/html/planora>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Abilita il rewrite per React Router
        RewriteEngine On
        RewriteBase /planora/
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.html [L]
    </Directory>

    # Backend Node.js API - Reverse Proxy a localhost:4000
    ProxyPreserveHost On
    ProxyPass /planora-api http://localhost:4000
    ProxyPassReverse /planora-api http://localhost:4000

    # WebSocket Support per Socket.IO (chat e notifiche real-time)
    ProxyPass /socket.io/ http://localhost:4000/socket.io/
    ProxyPassReverse /socket.io/ http://localhost:4000/socket.io/

    <Location /socket.io/>
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} =websocket [NC]
        RewriteRule /(.*)           ws://localhost:4000/$1 [P,L]
    </Location>

    # Headers CORS per API
    <Location /planora-api>
        Header set Access-Control-Allow-Origin "https://www.licenzeoriginali.com"
        Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header set Access-Control-Allow-Credentials "true"
    </Location>

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Comprimi risposte per migliorare performance
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Log Files
    ErrorLog ${APACHE_LOG_DIR}/planora-error.log
    CustomLog ${APACHE_LOG_DIR}/planora-access.log combined
</VirtualHost>

# HTTPS Configuration (SSL/TLS)
# Dopo aver ottenuto un certificato SSL (es. Let's Encrypt)
<VirtualHost *:443>
    ServerName www.licenzeoriginali.com
    ServerAlias licenzeoriginali.com

    DocumentRoot /var/www/html

    # SSL Certificate (usa Let's Encrypt o il tuo certificato)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/licenzeoriginali.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/licenzeoriginali.com/privkey.pem
    # Include /etc/letsencrypt/options-ssl-apache.conf

    # Frontend React - /planora
    <Directory /var/www/html/planora>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        RewriteEngine On
        RewriteBase /planora/
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^ index.html [L]
    </Directory>

    # Backend Node.js API - Reverse Proxy
    ProxyPreserveHost On
    ProxyPass /planora-api http://localhost:4000
    ProxyPassReverse /planora-api http://localhost:4000

    # WebSocket Support
    ProxyPass /socket.io/ http://localhost:4000/socket.io/
    ProxyPassReverse /socket.io/ http://localhost:4000/socket.io/

    <Location /socket.io/>
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} =websocket [NC]
        RewriteRule /(.*)           ws://localhost:4000/$1 [P,L]
    </Location>

    # Headers CORS
    <Location /planora-api>
        Header set Access-Control-Allow-Origin "https://www.licenzeoriginali.com"
        Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header set Access-Control-Allow-Credentials "true"
    </Location>

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Log Files
    ErrorLog ${APACHE_LOG_DIR}/planora-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/planora-ssl-access.log combined
</VirtualHost>

# ==============================================================================
# COME USARE QUESTA CONFIGURAZIONE:
# ==============================================================================
#
# 1. Su Ubuntu/Debian:
#    sudo nano /etc/apache2/sites-available/planora.conf
#    [Incolla questa configurazione]
#    sudo a2ensite planora.conf
#    sudo service apache2 reload
#
# 2. Su XAMPP Linux:
#    sudo nano /opt/lampp/etc/extra/httpd-vhosts.conf
#    [Aggiungi questa configurazione]
#    sudo /opt/lampp/lampp restart
#
# 3. Su XAMPP Windows:
#    Apri: C:\xampp\apache\conf\extra\httpd-vhosts.conf
#    [Aggiungi questa configurazione]
#    Riavvia Apache dal pannello XAMPP
#
# 4. Abilita i moduli necessari (Linux):
#    sudo a2enmod rewrite proxy proxy_http headers ssl
#    sudo service apache2 restart
#
# ==============================================================================
